# Terraform - Agent Guidelines
- The project is using OpenTofu instead of Terraform.
- For any change, if relevant, first create a Terratest test that will test this change. Verify that it fails.
- For Terratest tests you are not allowed to create apply/destroy tests. Create a single main.tf and various tfvars files inside tests subfolder.
- After implementation, validate it using `tofu plan` command inside the appropriate stack folder. Filter out output to preserve tokens. Verify exact field changes.
- Verify that resources specified in the root module (input main.tf or terragrunt.hcl) are visible in the plan.
- Make sure all tests pass.
- At the end, run `task fmt` to automatically format modules and `task docs` to generate documentation.

## Code Style Guidelines
- Prefer creating resources with awscc provider (AWS Cloud Control API). Prefer using aws provider for data resources only. AWS cloud control is autogenerated from AWS CloudFormation resource providers, so use cloudformation template reference to figure out the proper parameters.
- Resource naming: `this` for single resources, plural for collections (e.g., `awscc_ec2_vpc.this`, `awscc_ec2_subnet.this`).
- Variable names: snake_case, descriptive and consistent with AWS terminology.
- Avoid modifying variables structure inside the root module (input main.tf or terragrunt.hcl) unless explicitly asked.
- Tags: merge common_tags with resource-specific tags using merge() function.
- Use for_each for multiple resources, count for conditional single resources.
- When terraform logical id consists of multiple parts, separate them with underscore.
- If possible, avoid creating new local variables in locals.tf. However if you need to lookup some parameter (e.g. map from data), or do very complex calculations, data transformations you can add a necessary local variable.
- Put data sources into data.tf.
- Put Terraform check statements into checks.tf.
- Put outputs into outputs.tf. Return full resources from provider when relevant. When there is a resource with "tags" attribute, convert it from list of maps into a single map.
- Cleanup unused variables and statements in terraform files when making changes.
- Avoid changing reference.md files manually, use `task docs` to regenerate them.
- Fix README.md when it is outdated (e.g. the input interface changes).

## Tool selection
When you need to call tools from the shell, use the following tools if they are available on the ystem:

- Find files: `fd`
- Find Text: `rg` (ripgrep)
- Find Code Structure: `ast-grep`
  - Default to TypeScript when in TS/TSX repos:
    - `.ts` → `ast-grep --lang ts -p '<pattern>'`
    - `.tsx` (React) → `ast-grep --lang tsx -p '<pattern>'`
  - Other common languages:
    - Python → `ast-grep --lang python -p '<pattern>'`
    - Bash → `ast-grep --lang bash -p '<pattern>'`
    - JavaScript → `ast-grep --lang js -p '<pattern>'`
    - Rust → `ast-grep --lang rust -p '<pattern>'`
    - JSON → `ast-grep --lang json -p '<pattern>'`
    - HCL → `ast-grep --lang hcl -p '<pattern>'`
- Select among matches: pipe to `fzf`
- JSON: `jaq`
- YAML/XML: `yq`

If `ast-grep` is available, avoid plain‑text searches (`rg`/`grep`) when you need syntax‑aware matching. Use `rg` only when a plain‑text search is explicitly requested.
